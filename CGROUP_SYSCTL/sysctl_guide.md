# Путеводитель по bpf_sysctl (CGROUP_SYSCTL)

Этот файл объясняет использование eBPF‑программ, перехватывающих доступ к sysctl на уровне cgroup (`BPF_PROG_TYPE_CGROUP_SYSCTL`). Эти программы позволяют наблюдать и ограничивать чтение/запись параметров `/proc/sys/...`, а также переписывать значения.

## Контекст и ключевые поля

Контекст `bpf_sysctl` предоставляет минимум информации напрямую и опирается на хелперы. Базовые поля включают:

- `write`: флаг операции (0 — чтение, 1 — запись).
- `file_pos`: позиция в потоке чтения/записи (смещение для многочастных значений).

Прочие данные (имя узла, текущее и новое значение) получаются через хелперы.

## Основные хелперы

- `bpf_sysctl_get_name(ctx, buf, size, flags)`: получить имя узла (например, `kernel/panic`).
- `bpf_sysctl_get_current_value(ctx, buf, size)`: прочитать текущее текстовое значение параметра.
- `bpf_sysctl_set_new_value(ctx, buf, size)`: записать новое текстовое значение (в хуке записи).

Буферы — текстовые; значения sysctl представлены строками. Проверяйте длину и терминируйте при необходимости.

## Возврат и политика

- `return 1` — разрешить операцию (с учётом возможных изменений);
- `return 0` — запретить доступ к параметру.

Примеры политик:
- Запретить запись `kernel/panic` или ограничить её диапазон;
- Разрешить чтение, но блокировать запись некоторых веток (`net/ipv4/conf/*`).

## Практические замечания

- Валидируйте ввод: sysctl — текстовые значения; проверяйте, что строка корректна и в допустимых пределах.
- Некоторые узлы sysctl являются только для чтения/записи: учитывайте это при формировании ответа.
- Набор доступных хелперов и поведение могут отличаться между версиями ядра — сверяйтесь с UAPI документацией вашей системы.
