# Путеводитель по bpf_sockopt (CGROUP_SOCKOPT)

Этот файл описывает контекст `bpf_sockopt` для хуков `BPF_CGROUP_SOCKOPT` (перехват `getsockopt/setsockopt` на уровне cgroup). Программа может читать и менять значения опций сокетов, а также блокировать или навязывать параметры.

## Базовые поля (строго по структуре)

- `sk`: указатель на `struct bpf_sock`, соответствующий сокету.
- `optval`: указатель на начало буфера значения опции, доступного в BPF.
- `optval_end`: указатель на конец буфера значения опции.
- `level`: уровень опции (например, `SOL_SOCKET`, `IPPROTO_TCP`, `IPPROTO_IP`, `IPPROTO_IPV6`).
- `optname`: имя опции (например, `SO_PRIORITY`, `TCP_NODELAY`, `TCP_CONGESTION`, …).
- `optlen`: длина буфера `optval`.
- `retval`: код возврата системного вызова (может быть изменён программой).

## Типичные сценарии

- Принудительно включать `TCP_NODELAY` (`level=IPPROTO_TCP`, `optname=TCP_NODELAY`) для cgroup с низкими задержками.
- Ограничивать `SO_PRIORITY`/`SO_MARK` в заданных пределах.
- Блокировать смену `TCP_CONGESTION` на запрещённые алгоритмы.

## Возврат и поведение

- Как правило, `return 1` — продолжить обычную обработку ядром (с учётом правок буфера), `return 0` — прервать/заблокировать операцию. При блокировке установите `retval` в соответствующий отрицательный errno (например, `-EPERM`).

## Практические замечания

- Проверяйте границы перед чтением/записью: любые обращения должны быть строго в диапазоне `[optval, optval_end)`.
- Формат `optval` зависит от `level/optname` (целое, строка, структура); интерпретируйте по соответствующим UAPI заголовкам.
- Направление (GET/SET) определяется контекстом вызова ядра, но отдельного поля `op` в `bpf_sockopt` нет; пишите логику, исходя из того, что вы перехватываете.
