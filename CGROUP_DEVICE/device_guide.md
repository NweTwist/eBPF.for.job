# Путеводитель по bpf_cgroup_dev_ctx (CGROUP_DEVICE)

Этот файл объясняет поля контекста `bpf_cgroup_dev_ctx` для eBPF‑программ, прикрепляемых к cgroup controller устройства (BPF_PROG_TYPE_CGROUP_DEVICE). Программа получает этот контекст при попытке процесса взаимодействовать с устройством, чтобы решить — разрешить или запретить.

## Поля контекста

- `access_type`: битовая маска типа операции над устройством.
  - Основные флаги (UAPI): `BPF_DEVCG_READ`, `BPF_DEVCG_WRITE`, `BPF_DEVCG_MKNOD`.
  - READ/WRITE — попытка открыть устройство на чтение/запись; MKNOD — попытка создать узел устройства (`mknod(2)`).
  - Флаги могут комбинироваться (например, чтение+запись).

- `major`: старший номер устройства.
  - Идентифицирует драйвер/класс устройства согласно схеме нумерации Linux.
  - Справочник номеров: Linux v6.1 — https://www.kernel.org/doc/html/v6.1/admin-guide/devices.html

- `minor`: младший номер устройства.
  - Идентифицирует конкретный экземпляр внутри `major` (например, конкретный диск/раздел).

## Возврат и политика

- Возврат `1` — разрешить, `0` — запретить операцию.
- Типичные политики:
  - Запретить `MKNOD` для всех: если `access_type & BPF_DEVCG_MKNOD`, вернуть `0`.
  - Разрешить только READ для выбранных `major:minor`.
  - Разрешить доступ к целому классу устройств по `major`, но ограничить запись на отдельные `minor`.

## Практические замечания

- READ/WRITE означают режимы открытия устройства (O_RDONLY/O_WRONLY/O_RDWR), а не операции чтения/записи файлов.
- Политики одинаково применяются к символьным и блочным устройствам — тип отражён самим устройством, а не полями контекста.
- Список `major/minor` и их семантика зависят от версии ядра; сверяйтесь с документацией вашей версии.

## Краткие примеры

- «Запретить создание любых устройств»: если `access_type` содержит `BPF_DEVCG_MKNOD` → `return 0;`.
- «Разрешить чтение дисков SCSI (major=8), но запретить запись, кроме `minor=0`»: ветвление по `major==8`, маске READ/WRITE и `minor`.
