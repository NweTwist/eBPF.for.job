# Путеводитель по bpf_sock_addr (CGROUP_SOCK_ADDR)

Этот файл объясняет контекст `bpf_sock_addr` для хуков `BPF_CGROUP_INET{4,6}_CONNECT` и `BPF_CGROUP_INET{4,6}_BIND`. Эти программы могут проверять и изменять адрес/порт, к которому процесс подключается или на который привязывается.

## Базовые поля

- `family`: семейство адресов сокета (`AF_INET` или `AF_INET6`). Только для чтения.
- `user_family`: семейство адреса, которое пришло от приложения в системный вызов (адрес из user space). Может отличаться от `family` в сценариях dual‑stack/IPv4‑mapped.
- `type`: тип сокета (`SOCK_STREAM`, `SOCK_DGRAM`, …). Только для чтения.
- `protocol`: протокол (`IPPROTO_TCP`, `IPPROTO_UDP`, …). Только для чтения.

## Модифицируемые адрес и порт

- IPv4: `user_ip4` (адрес назначения/привязки), `user_port` (порт).
- IPv6: `user_ip6[4]` (адрес из 4×32‑бит слов), `user_port` (порт).

Замечания по представлению:
- `user_port` имеет тип `__u32`, но хранит 16‑битное значение порта в сетевом порядке (big‑endian). Сравнивая/записывая, учитывайте порядок байт и младшие 16 бит.
- Для IPv6 адрес разбит на четыре 32‑битных слова в сетевом порядке.

Программа может переписать `user_ip*` и/или `user_port`, чтобы перенаправить соединение/привязку (например, редиректить `*:22` на локальную службу или блокировать запрещённые адреса).

## Поля источника для sendmsg/recvmsg

- `msg_src_ip4`: исходный IPv4, указанный/подставляемый при `sendmsg`/`recvmsg` (в зависимости от хука). Можно читать/перезаписывать, чтобы навязать исходный адрес.
- `msg_src_ip6[4]`: исходный IPv6 в виде 4×32‑бит слов для сценариев `sendmsg`/`recvmsg`.

Эти поля используются в соответствующих UDP/TCP хуках семейства `CGROUP_SOCK_ADDR`, когда приложение задаёт источник через ancillary‑данные/параметры или когда политика должна его переписать.

## Связь с сокетом

- `sk`: указатель на `struct bpf_sock`, если ядро может сопоставить текущую операцию с сокетом. Позволяет привязать политику к владельцу (процесс/cgroup), интерфейсу и атрибутам соединения. Может быть недоступен для некоторых этапов/типов операций.

## Дополнительные поля и замечания

- `bound_dev_if` не входит в структуру `bpf_sock_addr`, но может быть доступен через другие контексты/хелперы и полезен для политики «привязки к интерфейсу».

## Возврат и политика

- `return 1` — разрешить (с учётом возможных изменений полей);
- `return 0` — запретить (операция отклоняется).

Примеры:
- Блокировать исходящие TCP к портам 25/110; 
- Принудительно перенаправлять `connect()` на адрес балансировщика;
- Ограничивать `bind()` на конкретные порты и адреса.

## Практические замечания

- Проверяйте `family` перед доступом к полям IPv4/IPv6.
- Всегда учитывайте сетевой порядок байт у портов при сравнении/записи.
- Доступность полей может отличаться между версиями ядра — сверяйтесь с `include/uapi/linux/bpf.h` вашей системы.
