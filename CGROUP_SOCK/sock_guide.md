# Путеводитель по bpf_sock (CGROUP_SOCK)

Этот файл описывает контекст `bpf_sock` для eBPF‑программ, прикрепляемых к cgroup‑хукам уровня сокета, таким как `BPF_CGROUP_INET_SOCK_CREATE`. Эти программы видят атрибуты создаваемого/существующего сокета и могут разрешить/запретить операцию или изменить некоторые поля.

## Идентификация сокета

- `family`: семейство адресов (`AF_INET`, `AF_INET6`).
- `type`: тип сокета (`SOCK_STREAM`, `SOCK_DGRAM`, др.).
- `protocol`: протокол уровня L4 (`IPPROTO_TCP`, `IPPROTO_UDP`, др.).

Эти поля позволяют, например, блокировать создание TCP‑сокетов или разрешать только UDP.

## Адреса и порты (могут зависеть от этапа)

- Источник: `src_ip4`/`src_ip6[4]`, `src_port` — локальный IP/порт.
- Назначение: `dst_ip4`/`dst_ip6[4]`, `dst_port` — удалённый IP/порт.

Замечание: при `SOCK_CREATE` адреса ещё могут быть не заданы (нулевые), они появляются после `bind/connect`. Для контроля `bind/connect` используйте хуки `CGROUP_SOCK_ADDR` (см. отдельный гайд).

## Маркировка и QoS

- `mark`: policy‑метка (fwmark), влияет на маршрутизацию/фильтрацию.
- `priority`: приоритет трафика сокета.
- `bound_dev_if`: индекс интерфейса, на который сокет привязан (аналог `SO_BINDTODEVICE`).
- `rx_queue_mapping`: номер RX‑очереди, с которой ассоциирован сокет/приём. Помогает понимать распределение нагрузки по очередям NIC и может использоваться для политики балансировки.

## TCP‑специфика (дополнительно)

Через helper доступна структура `bpf_tcp_sock` (для TCP‑сокетов): сведения о состоянии и метриках (окно, RTT, ssthresh и др.) — полезно для продвинутых политик. Доступность зависит от версии ядра и точки подключения.

Дополнительно для общего `bpf_sock` доступно поле `state`: текущее состояние сокета по таблице состояний (для TCP — `TCP_ESTABLISHED`, `TCP_SYN_SENT`, `TCP_LISTEN` и др.; для других типов — соответствующие значения). Полезно, чтобы отличать установленные соединения от попыток подключения или пассивного прослушивания и применять разные правила.

## Возврат и политика

- Как правило, `return 1` — разрешить, `return 0` — запретить операцию (создание/доступ).
- Типичные сценарии:
  - Запретить `SOCK_STREAM` с `IPPROTO_TCP` для определённых cgroup.
  - Разрешать сокеты только на конкретный интерфейс (`bound_dev_if`).
  - Назначать `mark`/`priority` для сегрегации и QoS.

## Практические замечания

- Значения адресов/портов доступны не на всех этапах; для правок параметров соединения используйте `CGROUP_SOCK_ADDR`.
- Порты в сетевом порядке байт (big‑endian) — учитывайте при сравнении.
- Набор доступных полей может отличаться по ядрам; сверяйтесь с UAPI вашей версии (`include/uapi/linux/bpf.h`).
